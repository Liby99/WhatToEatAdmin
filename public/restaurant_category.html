<!DOCTYPE html>
<html>
    <head>
        <title>What To Eat - Admin Edit Project</title>
        <link rel="stylesheet" href="css/lib/font-awesome.css" />
        <link rel="stylesheet" href="css/lib/bootstrap.css" />
        <link rel="stylesheet" href="css/lib/summernote_liby.css" />
        <link rel="stylesheet" href="css/lib/datetimepicker.css" />
        <link rel="stylesheet" href="css/basic.css" />
        <script src="js/lib/jquery.js"></script>
        <script src="http://www.parsecdn.com/js/parse-1.6.14.min.js"></script>
        <script src="js/lib/bootstrap.js"></script>
        <script src="js/lib/datetimepicker.js"></script>
        <script src="js/lib/summernote.js"></script>
        <script src="js/util.js"></script>
        <script>const PAGE = "manage-category"</script>
        <style>
            #editing {
                margin: 0;
                line-height: 20px;
                width: auto;
                display: inline-block;
            }
            
            #add-category {
                margin: 0;
                line-height: 20px;
                width: auto;
                display: inline-block;
            }
            
            .category-edit {
                margin-left: 10px;
            }
        </style>
    </head>
    <body>
        <nav>
            <% include view/sidebar.html %>
        </nav>
        <main>
            <div id="main-title">Manage Category</div>
            <div id="main-frame">
                <table id="category-table">
                    <tr id="category-table-head">
                        <th>ID</th>
                        <th>Name</th>
                        <th>Delete</th>
                    </tr>
                    <tr id="category-table-add">
                        <td></td>
                        <td>
                            <form id="category-add-form">
                                <input type="text" id="add-category" placeholder="Add Category" />
                                <button type="submit" class="small">Add</button>
                            </form>
                        </td>
                        <td></td>
                    </tr>
                </table>
            </div>
        </main>
    </body>
    <script src="js/basic.js"></script>
    <script>
        $(document).ready(function () {
            CategoryManage.initiate();
        });
        
        var CategoryManage = {
            initiate: function () {
                var self = this;
                self.initiateAdd();
                this.load(function () {
                    self.initiateEdit();
                    self.initiateDelete();
                });
            },
            initiateEdit: function () {
                $(".editable").click(function () {
                    var editable = this;
                    var val = $(this).text();
                    var id = $(this).parent().parent().attr("id");
                    $(this).attr("hidden", "hidden");
                    $(this).parent().append("<form id=\"" + id + "-name-form\"><input id=\"editing\" /><button class=\"category-edit small\" type=\"submit\">Submit</button></form>");
                    $(editing).val(val);
                    $("#" + id + "-name-form").submit(function () {
                        var form = this;
                        var Category = Parse.Object.extend("Category");
                        var queryObject = new Parse.Query(Category);
                        queryObject.get(id, {
                            success: function (category) {
                                var newValue = $("#editing").val();
                                if (newValue != "") {
                                    category.set("name", newValue);
                                    category.save();
                                    $(form).remove();
                                    $(editable).text(newValue);
                                    $(editable).removeAttr("hidden");
                                }
                            },
                            error: function (error) {
                                alert("Submission Failed");
                            }
                        });
                        return false;
                    });
                });
            },
            initiateDelete: function () {
                $(".category-delete").click(function () {
                    var id = $(this).parent().parent().attr("id");
                    var Category = Parse.Object.extend("Category");
                    var queryObject = new Parse.Query(Category);
                    queryObject.get(id, {
                        success: function (category) {
                            category.destroy({
                                success: function (category) {
                                    window.location.reload();
                                },
                                error: function () {
                                    alert("Delete category failed");
                                }
                            });
                        },
                        error: function (error) {
                            alert("Error: " + JSON.stringify(error));
                        }
                    })
                });
            },
            initiateAdd: function () {
                $("#category-add-form").submit(function () {
                    var val = $("#add-category").val();
                    var Category = Parse.Object.extend("Category");
                    var category = new Category();
                    category.save({
                        "name": val
                    }, {
                        success: function (category) {
                            alert("Successfully Added Category");
                            window.location.reload();
                        },
                        error: function (error) {
                            alert("Add Category Failed");
                        }
                    });
                    return false;
                })
            },
            load: function (callback) {
                var Category = Parse.Object.extend("Category", {
                    render: function (id) {
                        return "<tr class=\"category\" id=\"" + this.id + "\">"
                            + "<td>" + (id + 1) + "</td>"
                            + "<td>"
                                + "<span class=\"editable\">" + this.get("name") + "</span>"
                            + "</td>"
                            + "<td>"
                                + "<button class=\"category-delete small\">Delete</button>"
                            + "</td>"
                        + "</tr>";
                    }
                });
                var queryObject = new Parse.Query(Category);
                queryObject.find({
                    success: function (categories) {
                        var html = "";
                        for (var i = 0; i < categories.length; i++) {
                            html += categories[i].render(i);
                        }
                        $("#category-table-add").before(html);
                        callback();
                    },
                    error: function (error) {
                        alert("Error: " + JSON.stringify(error));
                    }
                })
            }
        }
    </script>
</html>
